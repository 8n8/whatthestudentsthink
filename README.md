# What The Students Think

A simple [website](https://whatthestudentsthink.uk) for displaying the results of the National Student Survey.

# Program structure

The front end is written in Elm.  It retrieves data from the back end via JSON http requests.  The back end is written in Haskell.  There is no database.  It reads in the csv data files at startup and then holds all the data in memory.

# Building

First clone the repository and cd into it.

Software versions that the build is tested with:

+ [Elm](https://guide.elm-lang.org/install.html) 0.18.0
+ [Haskell Tool Stack](https://docs.haskellstack.org/en/stable/install_and_upgrade/) 1.7.1

The program has only been tested in Ubuntu Linux, version 16.04, both on the build machine and on the server.

You can build either a development or production version.  The dev version uses http on localhost:3000 and the production version uses https on port 443.  Edit the 'status' variable in haskellSrc/DevOrProduction to choose.

1. Build the back end with ```stack build```. 
2. Generate Data.elm (which contains integer codes for universities and subjects) by running ```stack exec generateCodes```.
3. Build the front end with ```elm-make --warn --output=main.js elmSrc/Main.elm``` .
4. Compress the Javascript file generated by Elm and put the result in the dataFiles directory with ```uglifyjs -o dataFiles/main.js main.js```. (Get uglifyjs [here](https://github.com/mishoo/UglifyJS2))

# Install on server

I used a droplet from [DigitalOcean](https://www.digitalocean.com/) for the server.  This is a Linux virtual machine and is cheap and convenient.

There are three scripts for copying the data and binaries over to the server.  They contain the server name hardcoded, so will need to be edited for a different server address.  Make a directory on the server called ~/wtst, and then run (on the build machine) the scripts copyData.sh, copyRedirect.sh, and copyServer.sh.

# Start the website

## Https

The https uses a free certificate from LetsEncrypt, using the Electronic Frontier Foundation's [certbot](https://certbot.eff.org/) tool.  The certificates are installed in /etc/letsencrypt/live/<domain>.  The path to these certificates is hard coded in the Haskell file haskellSrc/DevOrProduction.hs.  The owner of the files fullchain.pem and privkey.pem in the certificates directory will need to be changed to the user name of the account that will run the program.

## Accessing ports

There are two servers, one that listens on port 80 and redirects everything to port 443, and the main server that listens on port 443.  Since a normal user is not usually allowed to use these ports, the program authbind is used to make exceptions.  Install authbind (available with apt or apt-get in Ubuntu), and allow access to the ports by creating two files in /etc/authbind/byport, called 80 and 443.  Change the owner of these files to the user who will run the servers, and set the permissions to be executable by the owner.

## Run the servers

Use screen for this, so that the servers will continue to run after the ssh session has ended.  From inside the ~/wtst directory, run ```screen``` then ```authbind ./redirect```, then type ```Control-A d``` to detach the session, run ```screen``` again, run ```authbind ./server```, then detach it with ```Control-A d```.  The ssh session can then be ended and the servers will continue to run.

# TODO

+ There is no logging of requests to the server at the moment, which would be nice to have and not too hard to do.

+ There are no tests.  This does not matter too much since everything is quite simple and I have manually compared the charts with the data for several hundred data points.

+ The Office for Students has now released the data for 2018, but this code still uses the 2017 data.  It would be good to update it to use the new data.
